<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Education Edition World Experiment Editor</title>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismarine-nbt@1.11.0/dist/prismarine-nbt.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, Segoe UI, Roboto, Arial;
      background: #f5f5f7;
      color: #222;
    }

    header {
      text-align: center;
      padding: 30px 20px 10px;
      font-size: 32px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: #555;
      font-size: 16px;
      margin-bottom: 18px;
    }

    .container {
      max-width: 900px;
      background: #fff;
      margin: 0 auto;
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
    }

    .dropzone {
      border: 2px dashed #ccc;
      border-radius: 14px;
      padding: 40px;
      text-align: center;
      transition: 0.25s;
      background: #fafafa;
      cursor: pointer;
    }

    .dropzone:hover {
      border-color: #0b74ff;
      background: #f0f6ff;
    }

    input[type="file"] {
      margin-top: 15px;
    }

    #status {
      margin-top: 16px;
      font-size: 14px;
      color: #444;
      text-align: center;
    }

    h3 {
      margin-top: 25px;
      font-size: 22px;
    }

    .exp-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
      margin-top: 12px;
    }

    .exp-grid label {
      background: #f8f8f8;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      margin-top: 18px;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      background: #0b74ff;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #005ce6;
    }

    pre {
      margin-top: 20px;
      background: #f1f1f1;
      padding: 14px;
      border-radius: 10px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 13px;
    }
  </style>
</head>

<body>

<header>.mcworld Experiments Editor — Education Edition</header>
<div class="subtitle">Enable full experimental gameplay in any Education Edition world</div>

<div class="container">
  <div id="dropzone" class="dropzone">
    Drop a <b>.mcworld</b> or <b>.zip</b> here<br>
    <input id="fileInput" type="file" accept=".mcworld,.zip">
  </div>

  <div id="status"><small>Waiting for world...</small></div>

  <div id="controls" style="display:none;">
    <h3>Choose experiments to enable</h3>
    <div id="expList" class="exp-grid"></div>
    <button id="processBtn">Build & Download Modified World</button>
  </div>

  <h3 style="margin-top:30px;">Debug Output</h3>
  <pre id="debug"></pre>
</div>

<script>
(function () {

  const JSZip = window.JSZip;
  const pako = window.pako;
  const nbt = window.nbt;
  const debug = document.getElementById("debug");
  const status = document.getElementById("status");
  const dropzone = document.getElementById("dropzone");
  const fileInput = document.getElementById("fileInput");
  const controls = document.getElementById("controls");
  const expList = document.getElementById("expList");
  const processBtn = document.getElementById("processBtn");

  function log(msg, obj) {
    if (obj) debug.textContent += msg + " " + JSON.stringify(obj, null, 2) + "\n";
    else debug.textContent += msg + "\n";
    debug.scrollTop = debug.scrollHeight;
  }

  const EXPERIMENTS = [
    "experimental_gameplay",
    "holiday_creator_features",
    "beta_api",
    "upcoming_creator_features",
    "caves_and_cliffs",
    "compressed_chunks",
    "actor_system",
    "restructured_world_generation",
    "fluid_tick_updates",
    "terrain_generation_v2",
  ];

  function renderExperimentToggles() {
    expList.innerHTML = "";
    EXPERIMENTS.forEach(e => {
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" value="${e}"> ${e}`;
      expList.appendChild(label);
    });
  }
  renderExperimentToggles();

  // drag & drop
  ["dragenter", "dragover"].forEach(ev =>
    dropzone.addEventListener(ev, e => {
      e.preventDefault();
      dropzone.style.borderColor = "#0b74ff";
    })
  );

  ["dragleave", "drop"].forEach(ev =>
    dropzone.addEventListener(ev, e => {
      e.preventDefault();
      dropzone.style.borderColor = "#ccc";
    })
  );

  dropzone.addEventListener("drop", e => {
    const f = e.dataTransfer.files[0];
    if (f) loadWorld(f);
  });

  fileInput.addEventListener("change", e => {
    const f = e.target.files[0];
    if (f) loadWorld(f);
  });

  let loadedZip = null;
  let parsedNBT = null;
  let levelPath = null;
  let baseName = "world";

  async function loadWorld(file) {
    debug.textContent = "";
    status.textContent = "Loading " + file.name + "...";

    baseName = file.name.replace(/\.mcworld|\.zip/i, "");

    let zip;
    try {
      zip = await JSZip.loadAsync(file);
      loadedZip = zip;
    } catch (err) {
      status.textContent = "Failed to open archive";
      log("Zip error:", err);
      return;
    }

    status.textContent = "Archive loaded — searching for level.dat";

    let levelEntry = null;
    zip.forEach((path, entry) => {
      if (path.toLowerCase().endsWith("level.dat")) levelEntry = entry;
    });

    if (!levelEntry) {
      status.textContent = "level.dat not found!";
      return;
    }

    levelPath = levelEntry.name;

    const raw = await levelEntry.async("arraybuffer");
    let bytes = new Uint8Array(raw);

    let nbtBytes;
    try {
      nbtBytes = pako.ungzip(bytes);
      log("Gzip OK");
    } catch {
      log("Not gzipped; using raw bytes");
      nbtBytes = bytes;
    }

    try {
      parsedNBT = await new Promise((resolve, reject) => {
        nbt.parse(nbtBytes, (err, data) => err ? reject(err) : resolve(data));
      });
    } catch (e) {
      status.textContent = "Failed to parse NBT";
      log("NBT error:", e);
      return;
    }

    status.textContent = "World loaded — choose experiments";

    populateExistingExperiments();

    controls.style.display = "block";
  }

  function populateExistingExperiments() {
    const root = parsedNBT.value;
    const exp =
      root?.Data?.value?.Experiments?.value ||
      root?.Experiments?.value ||
      {};

    const enabled = new Set(Object.entries(exp).filter(e => e[1]?.value === 1).map(e => e[0]));

    document.querySelectorAll("#expList input").forEach(i => {
      i.checked = enabled.has(i.value);
    });
  }

  processBtn.addEventListener("click", async () => {
    if (!parsedNBT) return;

    const chosen = [...document.querySelectorAll("#expList input:checked")].map(i => i.value);

    const compound = {};
    chosen.forEach(e => compound[e] = { type: "byte", value: 1 });

    const root = parsedNBT.value;

    if (!root.Data) root.Data = { type: "compound", value: {} };
    if (!root.Data.value) root.Data.value = {};

    root.Data.value.Experiments = { type: "compound", value: compound };
    root.Experiments = { type: "compound", value: compound };

    let nbtBuf = nbt.writeUncompressed(parsedNBT);
    const gz = pako.gzip(new Uint8Array(nbtBuf));

    loadedZip.file(levelPath, gz, { binary: true });

    status.textContent = "Building new world...";

    const blob = await loadedZip.generateAsync({ type: "blob" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = baseName + "_experiments.mcworld";
    a.click();

    status.textContent = "Download ready!";
    log("Export complete");
  });

})();
</script>

</body>
</html>
