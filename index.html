<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.mcworld Experiments Editor — Education Edition</title>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <!-- ✔ Correct UMD build that exposes window.nbt  -->
  <script src="https://unpkg.com/prismarine-nbt@2.2.1/dist/prismarine-nbt.umd.js"></script>

  <style>
    body { font-family: system-ui; background:#f7f7f7; padding:20px; color:#222; }
    .card {
      max-width: 820px; margin:auto; padding:25px;
      background:white; border-radius:14px;
      box-shadow:0 5px 30px rgba(0,0,0,0.07);
    }
    .drop {
      border:2px dashed #ccc; padding:25px; border-radius:10px;
      text-align:center; background:#fafafa; cursor:pointer;
    }
    button {
      padding:12px 18px; background:#0b67ff; color:white;
      border:none; border-radius:8px; cursor:pointer; font-size:1rem;
    }
    .exp-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-top:15px; }
    pre { background:#eee; padding:10px; border-radius:6px; max-height:260px; overflow:auto; }
  </style>
</head>
<body>

<div class="card">
  <h1>.mcworld Experiments Editor — Education Edition</h1>
  <p>Enable <b>full experimental gameplay</b> inside any .mcworld file — entirely in your browser.</p>

  <div id="drop" class="drop">
    Drop a <b>.mcworld</b> or <b>.zip</b> here<br><br>
    <input id="fileInput" type="file" accept=".mcworld,.zip">
  </div>

  <p id="status"><i>Waiting for file…</i></p>

  <div id="controls" style="display:none;">
    <h3>Enable Experiments</h3>
    <div id="expList" class="exp-grid"></div>
    <br>
    <button id="buildBtn">Build & Download</button>
  </div>

  <h3>Debug Output</h3>
  <pre id="log"></pre>
</div>

<script>
const logEl = document.getElementById("log");
function log(...msg) {
  logEl.textContent += msg.join(" ") + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

const nbt = window.nbt; // ✔ guaranteed to exist with correct script
const drop = document.getElementById("drop");
const fileInput = document.getElementById("fileInput");
const statusEl = document.getElementById("status");
const controls = document.getElementById("controls");
const expList = document.getElementById("expList");

let zipFile, parsedNBT, levelPath, baseName;

const EXPERIMENTS = [
  "holiday_creator_features",
  "beta_api",
  "upcoming_creator_features",
  "experimental_gameplay",
  "caves_and_cliffs",
  "actor_system",
  "terrain_generation_v2"
];

function buildUI() {
  expList.innerHTML = "";
  EXPERIMENTS.forEach(id => {
    const label = document.createElement("label");
    label.innerHTML = `<input type="checkbox" value="${id}"> ${id}`;
    expList.appendChild(label);
  });
}
buildUI();

drop.addEventListener("dragover", e => e.preventDefault());
drop.addEventListener("drop", e => {
  e.preventDefault();
  if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
});
fileInput.addEventListener("change", () => {
  if (fileInput.files.length) handleFile(fileInput.files[0]);
});

async function handleFile(file) {
  log("Loading file:", file.name);
  statusEl.textContent = "Reading archive…";

  baseName = file.name.replace(/\.mcworld$|\.zip$/i, "");
  zipFile = await JSZip.loadAsync(file);

  // find level.dat
  levelPath = null;
  zipFile.forEach((p) => { if (p.endsWith("level.dat")) levelPath = p; });

  if (!levelPath) {
    statusEl.textContent = "Error: level.dat not found.";
    log("level.dat not found");
    return;
  }

  log("Found:", levelPath);

  let raw = await zipFile.file(levelPath).async("uint8array");

  // Try gunzip
  let nbtBytes;
  try {
    nbtBytes = pako.ungzip(raw);
  } catch {
    log("Not gzipped; using raw bytes");
    nbtBytes = raw;
  }

  // Parse NBT (✔ this now works)
  try {
    parsedNBT = await nbt.parse(nbtBytes);
  } catch (err) {
    log("NBT error:", err);
    statusEl.textContent = "Failed to parse NBT";
    return;
  }

  log("NBT parsed successfully.");
  statusEl.textContent = "Ready. Select experiments.";
  controls.style.display = "block";
}

document.getElementById("buildBtn").addEventListener("click", async () => {
  const selected = [...document.querySelectorAll("#expList input:checked")].map(c => c.value);
  log("Selected experiments:", selected.join(", "));

  const root = parsedNBT.value;

  if (!root.Data) root.Data = { type:"compound", value:{} };
  if (!root.Data.value) root.Data.value = {};

  const expObj = {};
  selected.forEach(id => expObj[id] = { type:"byte", value:1 });

  root.Data.value.Experiments = { type:"compound", value:expObj };

  const uncompressed = nbt.writeUncompressed(parsedNBT);
  const gzipped = pako.gzip(uncompressed);

  zipFile.file(levelPath, gzipped);

  const blob = await zipFile.generateAsync({ type:"blob" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = baseName + "_experiments.mcworld";
  a.click();

  statusEl.textContent = "Download ready.";
});
</script>

</body>
</html>
